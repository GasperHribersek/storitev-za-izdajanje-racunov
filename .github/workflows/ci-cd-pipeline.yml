name: CI/CD Pipeline

# Trigger on push to main and production branches
on:
  push:
    branches: [ main, production,  logout-button]
  pull_request:
    branches: [ main, production,  logout-button ]

env:
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/invoice-app
  NODE_VERSION: '18'

jobs:
  # ===========================
  # JOB 1: Run Tests
  # ===========================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: test_invoice_app
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # Cache npm dependencies for faster builds
      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('app/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: Install dependencies
        working-directory: ./app
        run: npm ci
      
      - name: Set test environment variables
        run: |
          echo "DB_HOST=127.0.0.1" >> $GITHUB_ENV
          echo "DB_USER=root" >> $GITHUB_ENV
          echo "DB_PASS=testpassword" >> $GITHUB_ENV
          echo "DB_NAME=test_invoice_app" >> $GITHUB_ENV
          echo "PORT=5000" >> $GITHUB_ENV
          echo "SESSION_SECRET=test_secret_key_for_testing" >> $GITHUB_ENV
      
      - name: Run database migrations
        working-directory: ./app
        run: |
          mysql -h 127.0.0.1 -u root -ptestpassword test_invoice_app < sql/schema.sql
      
      - name: Run all tests with coverage
        working-directory: ./app
        run: npm test -- --coverage
      
      - name: Upload test coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-coverage
          path: app/coverage/
          retention-days: 30

  # ===========================
  # JOB 2: Build Application
  # ===========================
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # Cache node_modules for production dependencies
      - name: Cache node_modules
        uses: actions/cache@v4
        id: cache-node-modules
        with:
          path: app/node_modules
          key: ${{ runner.os }}-node-modules-prod-${{ hashFiles('app/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-prod-
      
      # Only install if cache miss
      - name: Install production dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        working-directory: ./app
        run: npm ci --only=production
      
      - name: Create build artifact structure
        working-directory: ./app
        run: |
          mkdir -p build
          cp -r node_modules build/
          cp package*.json build/
          cp server.js build/
          cp -r config build/
          cp -r src build/
          cp -r sql build/
          echo "Build completed at $(date)" > build/BUILD_INFO.txt
          echo "Git Commit: ${{ github.sha }}" >> build/BUILD_INFO.txt
      
      # Upload build artifacts for use in later stages
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-build
          path: app/build/
          retention-days: 7

  # ===========================
  # JOB 3: Build and Push Docker Image
  # ===========================
  docker:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: build
    
    # Only run on push to main/production, not on PRs
    if: github.event_name == 'push'
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Setup Docker Buildx for advanced build features
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      # Extract metadata for Docker tags and labels
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      # Build and push Docker image with caching
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./app
          file: ./app/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE_NAME }}:buildcache,mode=max
      
      - name: Image digest
        run: echo "Docker image built and pushed successfully!"

  # ===========================
  # JOB 4: Deploy to Railway
  # ===========================
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: docker
    
    # Only deploy from main branch
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Install Railway CLI
      - name: Install Railway CLI
        run: npm i -g @railway/cli
      
      # Deploy to Railway using token
      - name: Deploy to Railway
        run: railway up --service=${{ secrets.RAILWAY_SERVICE_ID }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      
      - name: Deployment success
        run: |
          echo "ðŸš€ Successfully deployed to Railway!"
          echo "ðŸ“¦ Docker image: ${{ env.DOCKER_IMAGE_NAME }}:latest"
          echo "âœ… Application is now live on Railway"
